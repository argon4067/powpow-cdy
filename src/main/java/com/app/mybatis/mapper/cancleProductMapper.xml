<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="cancleProduct">
	<insert id="insert" parameterType="CancleProductVO">
		INSERT INTO TBL_CANCLE_PRODUCT(ID, MEMBER_ID, PRODUCT_ID, CANCLE_COUNT)
		VALUES(CANCLE_PRODUCT_SEQ.NEXTVAL, #{memberId}, #{productId}, #{cancleCount})
	</insert>
	
	<select id="selectBySeller" parameterType="map" resultType="CancleProductDTO">
		SELECT TCP.ID, SELLER_ID, MEMBER_ID, PRODUCT_ID, CANCLE_PRODUCT_DATE, CANCLE_COUNT,
		SELLER_EMAIL, SELLER_PASSWORD, SELLER_NAME, SELLER_PHONE, SELLER_SMS, SELLER_EMAILCHECK,
		MEMBER_IMAGE, MEMBER_NICKNAME, MEMBER_EMAIL, MEMBER_PHONE, MEMBER_ADDRESS, MEMBER_SMS, MEMBER_EMAILCHECK,
		PRODUCT_NAME, PRODUCT_PRICE, PRODUCT_IMAGE, PRODUCT_CODE, PRODUCT_TYPE,PRODUCT_CATEGORY_NAME,PRODUCT_DETAIL,
		PRODUCT_SUB_IMAGE1, PRODUCT_SUB_IMAGE2, PRODUCT_SUB_IMAGE3
		FROM TBL_CANCLE_PRODUCT TCP
		JOIN TBL_MEMBER TM 
		ON TCP.MEMBER_ID = TM.ID
		JOIN TBL_PRODUCT TP 
		ON TCP.PRODUCT_ID = TP.ID
		JOIN TBL_SELLER TS 
		ON TP.SELLER_ID = TS.ID AND TS.ID = #{sellerId}
		ORDER BY TCP.ID DESC
	</select>
	
	
	<select id="selectByDate" resultType="CancleProductDTO">
		SELECT 
    		SUM(CANCLE_COUNT) AS CANCLE_TOTAL_COUNT,
    		SUM(CANCLE_COUNT * PRODUCT_PRICE) AS CANCLE_TOTAL_PRICE
		FROM TBL_CANCLE_PRODUCT TCP
		JOIN TBL_MEMBER TM 
		ON TCP.MEMBER_ID = TM.ID
		JOIN TBL_PRODUCT TP
		ON TCP.PRODUCT_ID = TP.ID
		JOIN TBL_SELLER TS 
		ON TP.SELLER_ID = TS.ID
		WHERE TS.ID = #{sellerId}
    	AND TCP.CANCLE_PRODUCT_DATE BETWEEN TO_DATE(#{startDate}, 'YYYY-MM-DD') 
    	AND TO_DATE(#{endDate}, 'YYYY-MM-DD')	
		ORDER BY TCP.ID DESC
	</select>
	
	<select id="selectByDay" resultType="CancleProductDTO">
		SELECT 
		   CANCLE_PRODUCT_DATE,
		   SUM(PRODUCT_PRICE) AS TOTAL_CANCLED_PRICE,
		   SUM(CANCLE_COUNT) AS TOTAL_CANCLED_COUNT,
		   SUM(TOTAL_ORDER_PRICE) AS TOTAL_ORDERED_PRICE,
		   SUM(PRODUCT_COUNT) AS TOTAL_ORDERED_COUNT
		FROM (
		   SELECT 
		      TCP.ID, 
		      TCP.CANCLE_PRODUCT_DATE, 
		      TCP.CANCLE_COUNT,
		      TBP.PRODUCT_PRICE, 
		      TBO.PRODUCT_COUNT,
		      TBO.PRODUCT_COUNT * TBP.PRODUCT_PRICE AS TOTAL_ORDER_PRICE
		   FROM TBL_CANCLE_PRODUCT TCP
		   JOIN TBL_PRODUCT TBP
		   ON TCP.PRODUCT_ID = TBP.ID
		   LEFT JOIN TBL_ORDER TBO
		   ON TBO.PRODUCT_ID = TBP.ID
		   WHERE TCP.CANCLE_PRODUCT_DATE 
		      BETWEEN TO_DATE(#{startDate}, 'YYYY-MM-DD') 
		      AND TO_DATE(#{endDate}, 'YYYY-MM-DD')
		      AND SELLER_ID = #{sellerId}
		)
		GROUP BY CANCLE_PRODUCT_DATE
	</select>
	
</mapper>